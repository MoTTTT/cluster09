apiVersion: v1
kind: Namespace
metadata:
  name: observability
---
apiVersion: v1
kind: Secret
metadata:
  labels:
    cluster.x-k8s.io/provider: infrastructure-proxmox
    clusterctl.cluster.x-k8s.io: ""
    platform.ionos.com/secret-type: proxmox-credentials
  name: capmox-manager-credentials
  namespace: observability
stringData:
  secret: b16ed07c-0260-44bc-9e17-f23262a22f4a
  token: root@pam!root
  url: https://192.168.4.50:8006
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: ProxmoxMachineTemplate
metadata:
  name: observability-controlplane
  namespace: observability
spec:
  template:
    spec:
      checks:
        skipCloudInitStatus: true
        skipQemuGuestAgent: true
      disks:
        bootVolume:
          disk: virtio0
          sizeGb: 140
      format: qcow2
      full: true
      memoryMiB: 16384
      metadataSettings:
        providerIDInjection: true
      network:
        default:
          bridge: vmbr0
          model: virtio
      numCores: 2
      numSockets: 2
      sourceNode: venus
      templateID: 100
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: ProxmoxMachineTemplate
metadata:
  name: observability-worker
  namespace: observability
spec:
  template:
    spec:
      checks:
        skipCloudInitStatus: true
        skipQemuGuestAgent: true
      disks:
        bootVolume:
          disk: virtio0
          sizeGb: 140
      format: qcow2
      full: true
      memoryMiB: 16384
      metadataSettings:
        providerIDInjection: true
      network:
        default:
          bridge: vmbr0
          model: virtio
      numCores: 2
      numSockets: 2
      sourceNode: venus
      templateID: 100
---
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: TalosControlPlane
metadata:
  name: talos-controlplane
  namespace: observability
spec:
  controlPlaneConfig:
    controlplane:
      generateType: controlplane
      strategicPatches:
      - |
        machine:
          network:
            interfaces:
              - deviceSelector:
                  physical: true
                vip:
                  ip: 192.168.4.100
          install:
            disk: /dev/vda
            image: factory.talos.dev/nocloud-installer/6adc7e7fba27948460e2231e5272e88b85159da3f3db980551976bf9898ff64b:v1.11.1
          registries:
            config:
              harbor.podzone.cloud:
                auth:
                  username: admin
                  password: Harbor12345
            mirrors:
              docker.io:
                endpoints:
                  - https://harbor.podzone.cloud/v2/proxy-docker.io
                overridePath: true
              ghcr.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-ghcr.io
                overridePath: true
              gcr.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-gcr.io
                overridePath: true
              registry.k8s.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-registry.k8s.io
                overridePath: true
              quay.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-quay.io
                overridePath: true
              cr.fluentbit.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-cr.fluentbit.io
                overridePath: true
          kernel:
            modules:
              - name: drbd
                parameters:
                  - usermode_helper=disabled
              - name: drbd_transport_tcp
          kubelet:
            extraArgs:
              rotate-server-certificates: true
              cloud-provider: external
          features:
            kubernetesTalosAPIAccess:
              enabled: true
              allowedRoles:
                - os:reader
              allowedKubernetesNamespaces:
                - kube-system
          sysctls:
            vm.max_map_count: 262144
        cluster:
          apiServer:
            certSANs:
              - 192.168.1.80
              - freyr
          network:
            cni:
              name: none
          proxy:
            disabled: true
          extraManifests:
            - http://192.168.4.1/kubelet-serving-cert-approver.yaml
            - http://192.168.4.1/metrics-server.yaml
            - http://192.168.4.1/piraeus-operator.yaml
            - http://192.168.4.1/gateway-api.yaml
            - http://192.168.4.1/cilium.yaml
          externalCloudProvider:
            enabled: true
            manifests:
              - https://raw.githubusercontent.com/siderolabs/talos-cloud-controller-manager/main/docs/deploy/cloud-controller-manager.yml
      talosVersion: v1.10
  infrastructureTemplate:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    kind: ProxmoxMachineTemplate
    name: observability-controlplane
    namespace: observability
  replicas: 3
  version: v1.32.0
---
apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: TalosConfigTemplate
metadata:
  labels:
    cluster-name: observability
  name: talosconfig-worker
  namespace: observability
spec:
  template:
    spec:
      generateType: worker
      strategicPatches:
      - |
        machine:
          install:
            disk: /dev/vda
            image: factory.talos.dev/nocloud-installer/6adc7e7fba27948460e2231e5272e88b85159da3f3db980551976bf9898ff64b:v1.11.1
          registries:
            config:
              harbor.podzone.cloud:
                auth:
                  username: admin
                  password: Harbor12345
            mirrors:
              docker.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-docker.io
                overridePath: true
              ghcr.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-ghcr.io
                overridePath: true
              gcr.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-gcr.io
                overridePath: true
              registry.k8s.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-registry.k8s.io
                overridePath: true
              quay.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-quay.io
                overridePath: true
              cr.fluentbit.io:
                endpoints:
                  - http://harbor.podzone.cloud/v2/proxy-cr.fluentbit.io
                overridePath: true
          sysctls:
            vm.max_map_count: 262144
          kernel:
            modules:
              - name: drbd
                parameters:
                  - usermode_helper=disabled
              - name: drbd_transport_tcp
          kubelet:
            extraArgs:
              rotate-server-certificates: true
              cloud-provider: external
      talosVersion: v1.10
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: observability-workers
  namespace: observability
spec:
  clusterName: observability
  replicas: 3
  selector:
    matchLabels: null
  template:
    spec:
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
          kind: TalosConfigTemplate
          name: talosconfig-worker
          namespace: observability
      clusterName: observability
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
        kind: ProxmoxMachineTemplate
        name: observability-worker
        namespace: observability
      version: v1.32.0
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: ProxmoxCluster
metadata:
  name: proxmox-cluster
  namespace: observability
spec:
  allowedNodes:
  - venus
  controlPlaneEndpoint:
    host: 192.168.4.100
    port: 6443
  credentialsRef:
    name: capmox-manager-credentials
    namespace: observability
  dnsServers:
  - 8.8.8.8
  - 8.8.4.4
  ipv4Config:
    addresses:
    - 192.168.4.101-192.168.4.107
    gateway: 192.168.4.1
    prefix: 24
  schedulerHints:
    memoryAdjustment: 0
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: observability
  namespace: observability
spec:
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
    kind: TalosControlPlane
    name: talos-controlplane
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    kind: ProxmoxCluster
    name: proxmox-cluster
